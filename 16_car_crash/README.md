# Оценка риска ДТП по выбранному маршруту движения

Вы — специалист по Data Sciense в каршеринговой компании. Вам поступил заказ: нужно создать систему, которая могла бы оценить риск ДТП по выбранному маршруту движения. 

Под риском понимается вероятность ДТП с любым повреждением транспортного средства. Как только водитель забронировал автомобиль, сел за руль и выбрал маршрут, система должна оценить уровень риска. Если уровень риска высок, водитель увидит предупреждение и рекомендации по маршруту.

Идея создания такой системы находится в стадии предварительного обсуждения и проработки. Чёткого алгоритма работы и подобных решений на рынке ещё не существует. Текущая задача — понять, возможно ли предсказывать ДТП, опираясь на исторические данные одного из регионов.

Заказчик предлагает вам поработать с базой данных по происшествиям и сформировать свои идеи создания такой системы. Идея решения задачи от заказчика: 

1. Создать модель предсказания ДТП (целевое значение — at_fault (виновник) в таблице parties)
    - Для модели выбрать тип виновника — только машина (car).
    - Выбрать случаи, когда ДТП привело к любым повреждениям транспортного средства, кроме типа SCRATCH (царапина).
    - Для моделирования ограничиться данными за 2012 год — они самые свежие.
    - Обязательное условие — учесть фактор возраста автомобиля.
    
    
2. На основе модели исследовать основные факторы ДТП.


3. Понять, помогут ли результаты моделирования и анализ важности факторов ответить на вопросы:
    - Возможно ли создать адекватную системы оценки водительского риска при выдаче авто?
    - Какие ещё факторы нужно учесть?
    - Нужно ли оборудовать автомобиль какими-либо датчиками или камерой?

 Оформление: Выполните задание в Jupyter Notebook. Заполните программный код в ячейках типа code, текстовые пояснения — в ячейках типа markdown. Примените форматирование и заголовки.   

 Краткое описание таблиц

**collisions — общая информация о ДТП**

Имеет уникальный case_id. Эта таблица описывает общую информацию о ДТП. Например, где оно произошло и когда.

**parties — информация об участниках ДТП**

Имеет неуникальный case_id, который сопоставляется с соответствующим ДТП в таблице collisions. Каждая строка здесь описывает одну из сторон, участвующих в ДТП. Если столкнулись две машины, в этой таблице должно быть две строки с совпадением case_id. Если нужен уникальный идентификатор, это case_id and party_number.

**vehicles — информация о пострадавших машинах**

Имеет неуникальные case_id и неуникальные party_number, которые сопоставляются с таблицей collisions и таблицей parties. Если нужен уникальный идентификатор, это case_id and party_number.

![Описание таблиц данных](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/16_car_crash/16_car_crash.png)


## Цель исследования:

Cоздание системы, которая могла бы оценить риск ДТП по выбранному маршруту движения, используя sql-запросы и смоделировав не менее 3-х типов моделей с перебором гиперпараметров. Продемонстрировать заказчику, помогут ли результаты моделирования и анализ важности факторов в решении поставленной задачи.

## Ход исследования:

Шаг 1. Загрузим таблицы sql

Подключимся к базе данных, используя данные:

db_config = {
'user': 'praktikum_student', # имя пользователя,
'pwd': 'Sdf4$2;d-d30pp', # пароль,
'host': 'rc1b-wcoijxj3yxfsf3fs.mdb.yandexcloud.net',
'port': 6432, # порт подключения,
'db': 'data-science-vehicle-db' # название базы данных,
} 

Шаг 2. Проведем первичное исследование таблиц

- Все ли таблицы имеют набор данных;
- Соответствует ли количество таблиц условию задачи;
- Имеется ли общий ключ для связи таблиц.

Для осмотра таблиц используем sql-запрос.

Шаг 3. Проведем статистический анализ факторов ДТП

1. Выясним, в какие месяцы происходит наибольшее количество аварий, проанализировав весь период наблюдений (таблица collisions).
    - Создадим sql-запрос;
    - Построим график;
    - Сделаем вывод.
    
2. Скоро состоится первое совещание вашей рабочей группы. Чтобы обсуждение было конструктивным, каждый сотрудник должен понимать данные. Для этого создадим подходящие аналитические задачи и поручим их решение коллегам. 
    
2.1. Создадим не менее шести задач для коллег. Опирайтесь на примеры и таблицы. 

1. Оценить серьёзность повреждений ТС, исходя из состояния водителя;
2. Оцените сумму страховых выплат в зависимости от возраста автомобиля;
3. Оцените серьёзность повреждений ТС, исходя из типа участника ДТП;
4. Определите регионы, в которых чаще всего возникают ДТП, для этих регионов определите категории нарушений;
5. Определите серьёзность повреждений ТС в зависимости от года выпуска автомобиля;
6. Оцените влияние освещения на вероятность возникновения ДТП

2.2. Пропишем порядок решения для двух задач из списка. Обязательное условие — решение этих задач должно включать связь не менее 2-х таблиц. Пример прописанного порядка:
    - Создайте sql-запрос;
    - Постройте график;
    - Сделайте вывод.
    
Шаг 4. Создадим модель для оценки водительского риска
1. Подготовим набор данных на основе первичного предположения заказчика:
 
    - Выберем тип виновника — только машина (car). 
    - Возьмем случаи, когда ДТП привело к любым значимым повреждениям автомобиля любого из участников — все, кроме типа SCRATCH (царапина).
    - Для моделирования возьмем данные только за 2012 год.
    - Подготовка исходной таблицы должна проводиться с помощью sql-запроса.
2. Проведем первичный отбор факторов, необходимых для модели.
Изучим описание факторов. Нужно отобрать те, которые могут влиять на вероятность ДТП. Аргументируем свой выбор. 

Пример:

columms =['party_type',     # Тип участника происшествия. Таблица parties
          'party_sobriety', # Уровень трезвости виновника (точно может влиять) Таблица parties
           ......]
         
3. Проведем статистическое исследование отобранных факторов.
    - По результату исследовательского анализа внесем корректировки, если они нужны. Сделаем вывод.
    - Если необходимо, категоризируем исходные данные, проведем масштабирование.
    - Подготовим обучающую и тестовую выборки.
    
Шаг 5. Найдем лучшую модель

1. Смоделируем не менее 3-х типов моделей с перебором гиперпараметров.
2. 1–2 модели из спринта 2;
3. 1–2 модели из спринта 3.
4. Выберем метрику для оценки модели, исходя из поставленной бизнесом задачи, обосновав свой выбор.
5. Оформим вывод в виде сравнительной таблицы.

Шаг 6. Проверим лучшую модель в работе

1. Проведем графический анализ «Матрица ошибок». Выведем полноту и точность на график.
2. Проанализируем важность основных факторов, влияющих на вероятность ДТП.
3. Для одного из выявленных важных факторов проведем дополнительное исследование:
    - Покажем график зависимости фактора и целевой переменной.
    - Предложим, чем можно оборудовать автомобиль, чтобы учесть этот фактор во время посадки водителя.

Шаг 7. Сделаем общий вывод по модели
    - Кратко опишем лучшую модель.
    - Сделаем вывод: насколько возможно создание адекватной системы оценки риска при выдаче авто?
    - Какие факторы ещё необходимо собирать, чтобы улучшить модель?



## Итог исследования:

В ходе исследования заказчиком было предоставлено несколько таблиц с данными, после первого просмотра оказалось, что: 

 - Все таблицы имеют набор данных;
 - Количество таблиц соответствует условию задачи;
 - Общий ключ для связи таблиц имеется.
 
От заказчика исследования нам предоставлена база данных с описанием дорожно транспортных проишествий в виде четырех таблиц, одна из которых является связывающей (case_ids), остальные - информационные, которые несут в себе характиристики машины (Vehicles), участников (Parties) и самого проишествия (Collisions). 

Все таблицы имеют данные, необходимые для обучения моделей и решения поставленной задачи. Представленных наблюдений около 1.400.000, что будет лишь положительно влиять на обучение. Однако, все таблицы связаны одним столбцом case_id, и если говорить про разность ключа таблицы case_ids со всеми оставшимися, то в vehicles будет найдено 607.358 несовпадений, что сократит нашу выборку почти в два раза, а при последующий срезах еще выше.

Нас просят предсказать риск проишествия по маршруту, но представлены данные только о проишествиях, поэтому если нам предстоит предсказывать безопасность пассажиров в автомобиле, тогда нам понадобятся все наблюдения, включающие в себя удачно завершенные поездки - без проишествий.

В ходе исследование перед рабочей группой были поставлены задачи, которые помогут коллегам разобраться в данных.
Выяснилось, что количество аварий с фатальными повреждениями ТС существенно выше в случае если водитель находится под воздействием лекарств (на них приходится больше 90% всех случаев), усталость и сонливость почти не влияют на риск ДТП с тяжёлыми последствиями.
Количество ДТП с участниками под лекарственными веществами и в сонном состоянии в количественном соотношении равны. Количество ДТП связанных с ухудшением физического состояния ощутимо меньше.
В целом соотношение типов ДТП совпадает за исключением процента тяжёлых транспортных проишествий.
Также существует определённая зависимость между возрастом автомобиля и суммой страховки - с увеличением возраста сумма выше, чем для новых, однако после достижения 15 лет страховка стремительно уменьшается.
Los Angeles, Orange и San Bernardino самые аварийные регионы в предложенных данных. При этом Los Angeles в несколько раз превосходит второй город по количеству ДТП. Самые частые нарушения - превышение скорости.

При формировании итогового датафрема использовались первичные предположения заказчика:

- Выбран тип виновника — только машина (car).
- Отобраны случаи, когда ДТП привело к любым значимым повреждениям автомобиля любого из участников — все, кроме типа SCRATCH (царапина).
- Для моделирования взяты данные только за 2012 год.
- Подготовка исходной таблицы проводилась с помощью sql-запроса.

В итоге собран датафрейм с 28 столбцами и 273115 наблюдениями, с общим весом 58 МБ. Наименование столбцов не требует исправлений, дисбаланс классов в пределе нормы. Тип данных требует исправления у некоторых характеристик. Неявных дубликатов в этой выборке не замечено, однако, если внимательно просмотреть разброс по некоторым столбцам, то можно заметить аномалии, к примеру, возраст машины 160 лет, скорее всего опечатка из-за человеческого фактора и там должно быть 16 лет. Подобные аномалии необходимо исправить при предобработке данных. Также присутствуют много NaN значений, если попытаться удалить их все, то мы можем лишиться практически всех данных. Поэтому я предлагаю следующий выход:

- Категориальные данные с NaN значениями < 1% мы заполним модой
- Категориальные данные с NaN значениями > 1% мы заполним значением 'unknown'. Таким образом мы будем держать некий баланс между правдой и дополнениями
- Столбец cellphone_in_use мы сделаем категориальным, на места NaN поставим unknown, а числа заменим на Y и N, тогда у нас не будет дополнительной ложной информации
- В столбце insurance_premium можно заметить неких 3 моды - в районе 21, 43 и 65, однако наибольшее скопление данных лежит в диапазоне от 19 до 26, поэтому мы рандомно заполним NaN значения этим диапазоном.
- Столбец vehicle_age мы заполним медианным значением
- Все остальные NaN будут удалены. Это менее 1% или 2000 наблюдений.

В результате предобработки данных было удалено менее 1% наблюдений, все остальные NaN значения были заполнены либо модой, либо медианным, либо unknown и other значениями. Столбцы 'vehicle_age', 'distance', 'intersection', 'insurance_premium' были переведены с float64 на int с определенной размерностью, что позволило чуть уменьшить размер датасета, а характеристики времени 'collision_date', 'collision_time' с типа данных object в DateTime. А также исправлена аномалия с возрастом равным 161 году на 16 лет, 'distance' == 1584000 было удалено из выборки. В итоге, после удаления неявных дубликатов, мы имеем обработанный датасет с 270.222 не нулевыми строками.

К необходимым для обучения столбцам были отнесены:

- insurance_premium (сумма страховки) - Сумма страховки может влиять на виновника проишествия. Водители с дешевой страховкой авто ездят менее аккуратно и чаще являются виновниками проишествий, в отличие от автомобилистов с дорогой страховкой машины.
- party_sobriety (Трезвость участника) -  Прямой фактор аварии, реакция ухудшена, состояние может быть любым : от головокружения, до потери зрения.
- party_drug_physical (состояние участника: физическое или с учётом принятых лекарств) - Некоторые лекарства могут вызвать головокружение, потерю внимательности, что приведёт к ухудшению реакции, возможна мультиколлениарность с признаком party_sobriety
- hour (время суток) - Данный столбец подробнее охватывает ситуацию с освещением в отличие от lighting.
- location_type (тип дороги) - На разных участках дороги возможны разные проишествия, однако при выезде на перекрёсток вероятность попасть в ДТП намного больше, чем на просторном шоссе.
- road_surface (состояние дороги) - Состояние дороги прямо влияет на манёвренность и на видимость, данные похожи на признак Погода	WEATHER_1, принято решение оставить один.
- road_condition_1 (дорожное состояние) - при высокой скорости ямы на дорогах или припятствия могут стать последствиями резкого манёвра, который приведёт к ДТП, а при сыпучем материале будет наименьшее сцепление с поверхностью дороги.
- county_location (названия географических районов, где произошло ДТП) - На ранее построенном графике мы увидели самые аварийные районы, количество ДТП в одних районах могут происходить чаще. Поэтому стоит добавить данный признак в нашу выборку.

Однако, выбранные признаки не сильно коррелируют с целевым признаком. Мультиколлениарность между признаками party_sobriety и party_drug_physical, как и ожидалось присутсвует, между ними существует сильная статистическая значимость.

В данном исследовании стоит задача бинарной классификации, для неё подходят следующие метрики оценки качества моделей: precision, recall и f1 мера. 
Precision можно интерпретировать как долю объектов, названных классификатором положительными и при этом действительно являющимися положительными.
Recall показывает, какую долю объектов положительного класса из всех объектов положительного класса нашел алгоритм.
Так как у нас необходимо угадать будет ли являться наш клиент виновником проишествия, то мы выберем метрику recall.

|   | Recall | LearningTime | PredictTime |
|--|--|--|--|
|DecisionTreeClassifier| 50.56% | 0.27 | 0.01 |
|RandomForestClassifier| 49.47%	 | 11.61 | 0.44 |
|CatBoostClassifier| 51.04%	 | 6.15 | 0.03 |
|XGBoost| 50.74% | 12.06 | 0.05 |

Модели градиентного бустинга суммарно выигрывают у деревянных моделей, однако случайный лес идёт с ними почти вровень, что не может не радовать. При выборе модели необходимо ориентироваться не только на точность нашей главной метрики, но и на скорость предсказания, для удобства клиента. Поэтому выбором будет CatBoost, который выиграл у всех по метрике recall, а также не отступает по времени предсказания.

![Анализ факторов влияющих на вероятность стать виновником ДТП](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/16_car_crash/16_impact.png)


В абсолютных величинах на решение о виновности в ДТП больше всего влияют:

insurance_premium (страховка машины) - Сумма страховки может влиять на виновника проишествия. Наблюдается явный пик около минимальной суммы страховки автомобиля. Водители с низкой страховкой авто ездят менее аккуратно и чаще являются виновниками ДТП. 

party_sobriety и party_drug_physical (трезвость и состояние участника) - очень схожие между собой признаки, решение данных проблем уже есть на рынке, вот как можно оборудовать машину:
необходимо оборудовать автомобиль анализатором опьянения и главным фктором к запуску двигателя будет процент вещества в организме. А чтобы мы понимали, что именно этот человек "дует в трубочку", поставим камеру или он будет снимать на телефон доказательства.

Hour (время суток) - чаще всего модель смотрит именно на ночное время суток:
Составлять в приложении маршруты таким образом, чтобы большая часть дороги была с освещением.

Погодные условия и состояние дорог одинаковые для участников движения, и все же проанализируем зависимость вероятности стать виновником ДТП от региона и от типа дороги. 

Если отвечать на первоначальный вопрос: "возможно создание адекватной системы оценки риска при выдаче авто?", то выданных данных недостаточно. Большинство факторов из выборки будут известны только после проишествия. Нам же нужны совсем иные данные, которые мы будем знать только, когда человек сел в машину и выбрал маршрут. Например, можно добавить в таблицу признаков клиента следующие факторы:

- возраст водителя, который будет прямо влиять на время реакции
- место работы
- среднюю скорость движения
- количество нарушений за всё время
- стаж, от этого будет зависить как он поведёт себя в той или иной ситуации.

В ходе исследования удалось обучить модель на тестовых данных и получить метрику Recall равную 51%, precision - 70%, а f1 - 59%. Это недостаточно хорошие показатели, 
однако на предсказаниях мы получаем следующие результаты:

- неправильно угадываем около 11 % данных, которые относятся к первому классу
- будем угадывать класс 1 - в районе 25% данных.
- чаще всего мы будем угадывать класс 0 - в 38% от случая.
- оставшиеся 26% - неудачные предсказания класса 0.

В данной работе мы попытались создать систему для каршеринговой компании, которая могла бы оценить риск ДТП по совокупности факторов.

Мы исследовали предоставленную базу, провели статистический анализ некоторых факторов.

Подготовили данные для анализа за 2012 год. Опробовали ряд моделей классического машинного обучения и бустингов.

Испытанные модели показали, что внедрение данных систем позволит в некоторой степени улучшить вероятность опознать потенциального виновника ДТП по ряду признаков.

Мы увидели что самыми влияющими факторами являются :

- страховка машины
- трезвость и состояние водителя
- время суток

Мы показали, что сам факт региона влияет на вероятность попасть в аварию, для типа дороги однозначного ответа нет, так как данных недостаточно, слишком много неизвестных значений.

Общий вклад трезвости и влияния лекарств довольно велик и его стоит учитывать. В машины стоит установить контрольное устройство. Возможно, добавить в камеру систему определения физического состояния водителя по времени реакции на раздражители, скорость моргания и сфокусированность зрения на дороге с включением звуковой сигнализации если водитель начинает спать или долго не смотрит на дорогу.

## Стек технологий:

`pandas`, `matplotlib`, `numpy`, `seaborn`, `plotly.express`, `statistics`, `scikit-learn`, `phik`, `shap`, `sqlalchemy`, `catboost`

## Статус проекта:

Завершен.
