# Определение возраста покупателей

Описание проекта

Сетевой супермаркет «Хлеб-Соль» внедряет систему компьютерного зрения для обработки фотографий покупателей. Фотофиксация в прикассовой зоне поможет определять возраст клиентов, чтобы: Анализировать покупки и предлагать товары, которые могут заинтересовать покупателей этой возрастной группы; Контролировать добросовестность кассиров при продаже алкоголя. Постройте модель, которая по фотографии определит приблизительный возраст человека. В вашем распоряжении набор фотографий людей с указанием возраста.

Данные взяты с сайта ChaLearn Looking at People. Они находятся в папке /datasets/faces/. 
В вашем распоряжении одна папка со всеми изображениями (/final_files) и CSV-файл labels.csv с двумя колонками: file_name и real_age. 

Инструкция по выполнению проекта

1. Проведите исследовательский анализ набора фотографий: 
    - Посмотрите на размер выборки.
    - Постройте график распределения возраста в выборке.
    - Напечатайте на экране 10–15 фотографий и посмотрите, как устроен датасет.
2. Подготовьте данные к обучению.
3. Обучите нейронную сеть и рассчитайте её качество.

![Пример фотографии](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/19_customer_age/19_examples.png)


Содержание

1.  Исследовательский анализ данных
    - 1.1  Загрузка библиотек
    - 1.2  Загрузка датасета
2.  Обучение модели
3.  Анализ обученной модели
4.  Выводы


## Цель исследования:

Построить и обучить свёрточную нейронную сеть на датасете с фотографиями людей. Добиться значения MAE на тестовой выборке не больше 8.


## Ход исследования:

Шаг 1. Загрузим данные, извлечь данные из папки вам поможет новый метод ImageDataGenerator —flow_from_dataframe(dataframe, directory, ...).

Шаг 2. Проведем исследовательский анализ данных:
- Посмотрим на размер выборки.
- Построим график распределения возраста в выборке.

![График распределения](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/19_customer_age/19_age_distribution.png)

- Напечатаем на экране 10–15 фотографий и посмотрите, как устроен датасет.

Шаг 3. Построим и обучим свёрточную нейронную сеть на датасете с фотографиями людей. Добьемся значения MAE на тестовой выборке не больше 8.
Функцией потерь не обязательно должна быть MAE, но зачастую нейронные сети с функцией потерь MSE обучаются быстрее.

Шаг 4. Проверим, что методы load_train(path) и load_test(path) корректно работают с данными. В папке path содержится CSV-файл labels.csv с двумя колонками file_name и real_age и папка с изображениями /final_files. Прочитаем данные из CSV-файла labels.csv в датафрейм, который будет одним из параметров метода ImageDataGenerator —flow_from_dataframe(dataframe, directory, ...).
Функцию загрузки тестовой выборки load_test(path) напишем самостоятельно. Вместе со старыми функциями в коде должны быть:
- load_train(path),
- load_test(path),
- create_model(input_shape),
- train_model(model, train_data, test_data, batch_size, epochs, steps_per_epoch, validation_steps).

Шаг 5. Проведем анализ обученной модели.



## Итог исследования:

В представленном датасете распределение по годам стремится к нормальной форме.

Всего 7591 фотографий, больше всего фотографий в диапазоне от 20 до 50 лет. 

Некоторые фотографии уже повернуты или обрезаны, размеры 224*224. Возможно, это повлияет на обучение и предсказания.

Попробовали применить архитектуру ResNet50, поменять learning rate: например, 0.001, 0.0001 и варианты между ними.

|   | mae | val_mae | val_mae | val_mae |
|--|--|--|--|--|
|Epoch 1/10| 10.0965 | 17.5457 | 191.6642 | 515.8337 |
|Epoch 4/10| 4.9770 | 6.4360 | 42.7527 | 79.8378 |
|Epoch 8/10| 3.1379 | 6.4446 | 16.6893 | 70.9046 |
|Epoch 10/10| 2.8352 | 6.1500 | 13.9685 | 65.9455 |

![Результат вывода модели на экран](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/19_customer_age/19_console_gpu.png)

Модель свёрточной нейронной сети за 10 эпох обучения уменьшила MAE с 10 до 2.83 на тренировочной выборке. На тестовой выборке результат составил 6,15.

В качестве костяка использована ResNet50 и головы с полносвязным слоем на один выход. Веса backbone были загружены из предобученной модели на датасете ImageNet (параметр weights='imagenet' в функции создания модели).

Параметры обучения модели:

- Размер батча: 16 (batch_size=16 в функциях загрузки данных)
- Оптимизатор: Adam с learning rate = 0.0001
- Заморозка весов бэкбона не использовалась, т.к. параметр include_top установлен в False, веса использовались только для бэкбона, а не для полносвязного слоя головы
- Количество эпох: 10 (параметр epochs в функции train_model)

Основываясь на результатах работы модели, трудно с уверенностью сказать, произошло ли переобучение или нет. Однако, можно сделать несколько обоснованных предположений:

Потери при обучении значительно уменьшились за десять эпох, что указывает на то, что модель хорошо усваивала обучающие данные.
Потери при проверке также первоначально уменьшились, но затем стали скакать, что может свидетельствовать о переобучении, поскольку модель начинает больше фокусироваться на обучающих данных и меньше на данных валидации.
Cтоит отметить, что потери при валидации резко не увеличились, поэтому возможно, модель не была переобучена, и увеличение потерь при валидации могло быть связано со случайным изменением данных при валидации.
На скрытых данных модель отработала хорошо, реальный возраст предсказыается в пределах плюс/минус 6 лет, что соответствует критериям проекта по определению приблизительного возраста человека, однако полноценное использование для контролирования добросовестности кассиров при продаже алкоголя с таким значением может быть критическим, необходимо увеличивать точность.

## Стек технологий:

`pandas`, `matplotlib`, `numpy`, `tensorflow`, `keras`, `ResNet50`, `Adam`, `ImageDataGenerator`

## Статус проекта:

Завершен.
